{% extends "base.html" %}

{% block title %}Reports - Therefore Report Generator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Reports</h1>
    <div>
        <a href="/reports/logs" class="btn btn-outline-info me-2">
            <i class="bi bi-journal-text me-2"></i>Run Logs
        </a>
        <a href="/reports/new" class="btn btn-primary {% if not has_active_tenants %}disabled{% endif %}">
            <i class="bi bi-plus-lg me-2"></i>New Report
        </a>
    </div>
</div>

{% if not has_active_tenants %}
<div class="alert alert-warning mb-4">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>No active tenants available.</strong> 
    Reports cannot be created until at least one tenant is activated.
    <a href="/tenants" class="alert-link">View Tenants</a>
</div>
{% endif %}

<div class="card">
    <div class="card-body p-0">
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Tenant</th>
                        <th>Schedule</th>
                        <th>Next Run</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>
                            <strong>{{ report.name }}</strong>
                            {% if report.description %}
                            <br><small class="text-muted">{{ report.description }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% for tenant in tenants %}
                                {% if tenant.id == report.tenant_id %}
                                {{ tenant.name }}
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <code>{{ report.cron_schedule }}</code>
                            <br><small class="text-muted">{{ report.timezone or 'Australia/Sydney' }}</small>
                        </td>
                        <td>
                            {% if report._next_run_formatted and report._next_run_formatted != '-' %}
                            {{ report._next_run_formatted }}
                            {% elif report.next_run %}
                            {{ (report.next_run[:16] | replace('T', ' ')) if report.next_run is string else report.next_run.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if report.enabled %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/reports/{{ report.id }}/test" class="btn btn-sm btn-outline-info" title="Test Report">
                                <i class="bi bi-bug"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-success" title="Run Now" 
                                    onclick="runReport({{ report.id }}, '{{ report.name|replace("'", "\\'") }}')">
                                <i class="bi bi-play-fill" id="run-icon-{{ report.id }}"></i>
                                <span class="spinner-border spinner-border-sm d-none" id="run-spinner-{{ report.id }}"></span>
                            </button>
                            <a href="/reports/{{ report.id }}/edit" class="btn btn-sm btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form method="post" action="/reports/{{ report.id }}/delete" 
                                  class="d-inline" onsubmit="return confirm('Delete this report?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-file-text" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No reports configured</h5>
            <p>Create reports to generate workflow summaries for your users.</p>
            <a href="/reports/new" class="btn btn-primary">Create Your First Report</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
async function runReport(reportId, reportName) {
    const icon = document.getElementById(`run-icon-${reportId}`);
    const spinner = document.getElementById(`run-spinner-${reportId}`);
    const button = icon.closest('button');
    
    // Show loading state
    icon.classList.add('d-none');
    spinner.classList.remove('d-none');
    button.disabled = true;
    
    try {
        const response = await fetch(`/reports/api/reports/${reportId}/run`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast(`Report "${reportName}" run successfully. ${data.message}`, 'success');
        } else {
            showToast(`Report "${reportName}" failed: ${data.message || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        showToast(`Error running report "${reportName}": ${error.message}`, 'error');
    } finally {
        // Reset button state
        icon.classList.remove('d-none');
        spinner.classList.add('d-none');
        button.disabled = false;
    }
}
</script>

{% if request.query_params.get('message') %}
<script>
    showToast("{{ request.query_params.get('message') }}", "success");
</script>
{% endif %}
{% endblock %}
