{% extends "base.html" %}

{% block title %}{{ 'Edit' if template else 'New' }} Template - Therefore Report Generator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">{{ 'Edit' if template else 'New' }} Email Template</h1>
    <a href="/templates" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Templates
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" action="{{ '/templates/' + template.id|string if template else '/templates' }}">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="name" class="form-label">Template Name *</label>
                    <input type="text" class="form-control" id="name" name="name" 
                           value="{{ template.name if template else '' }}" required>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label">Options</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_default" name="is_default" 
                               {{ 'checked' if template and template.is_default }}>
                        <label class="form-check-label" for="is_default">
                            Set as default template
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <input type="text" class="form-control" id="description" name="description" 
                       value="{{ template.description if template else '' }}">
            </div>
            
            <div class="mb-3">
                <label for="subject_template" class="form-label">Subject Template *</label>
                <input type="text" class="form-control" id="subject_template" name="subject_template" 
                       value="{{ template.subject_template if template else '' }}" required>
                <div class="form-text">Jinja2 template for email subject</div>
            </div>
            
            <div class="mb-3">
                <label for="body_template" class="form-label">Body Template *</label>
                <textarea class="form-control font-monospace" id="body_template" name="body_template" 
                          rows="20" required>{{ template.body_template if template else '' }}</textarea>
                <div class="form-text">Jinja2 HTML template for email body</div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>{{ 'Update' if template else 'Create' }} Template
                </button>
                <a href="/templates" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-code-square me-2"></i>Template Reference
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Available Variables</h6>
                <table class="table table-sm">
                    <tr><td><code>user.display_name</code></td><td>User's display name</td></tr>
                    <tr><td><code>user.email</code></td><td>User's email address</td></tr>
                    <tr><td><code>instances</code></td><td>List of all instances</td></tr>
                    <tr><td><code>overdue</code></td><td>List of overdue instances</td></tr>
                    <tr><td><code>not_overdue</code></td><td>List of non-overdue instances</td></tr>
                    <tr><td><code>instance_count</code></td><td>Total number of instances</td></tr>
                    <tr><td><code>overdue_count</code></td><td>Number of overdue instances</td></tr>
                    <tr><td><code>not_overdue_count</code></td><td>Number of non-overdue</td></tr>
                    <tr><td><code>now</code></td><td>Current datetime</td></tr>
                    <tr><td><code>timezone</code></td><td>Server timezone</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Instance Properties</h6>
                <table class="table table-sm">
                    <tr><td><code>instance.instance_no</code></td><td>Instance number</td></tr>
                    <tr><td><code>instance.process_no</code></td><td>Process number</td></tr>
                    <tr><td><code>instance.process_name</code></td><td>Process name</td></tr>
                    <tr><td><code>instance.task_name</code></td><td>Current task name</td></tr>
                    <tr><td><code>instance.task_start</code></td><td>Task start date</td></tr>
                    <tr><td><code>instance.task_due</code></td><td>Task due date</td></tr>
                    <tr><td><code>instance.user_display_name</code></td><td>Assigned user name</td></tr>
                    <tr><td><code>instance.user_smtp</code></td><td>Assigned user email</td></tr>
                    <tr><td><code>instance.index_data_string</code></td><td>Document index data</td></tr>
                    <tr><td><code>instance.twa_url</code></td><td>Direct link to instance</td></tr>
                    <tr><td><code>instance.is_overdue</code></td><td>Boolean overdue check</td></tr>
                </table>
            </div>
        </div>
        
        <h6 class="mt-3">Example Loop</h6>
        <pre class="bg-light p-3 rounded"><code>{% raw %}{% for instance in instances %}
&lt;tr&gt;
    &lt;td&gt;&lt;a href="{{ instance.twa_url }}"&gt;{{ instance.task_name }}&lt;/a&gt;&lt;/td&gt;
    &lt;td&gt;{{ instance.process_name }}&lt;/td&gt;
    &lt;td&gt;{{ instance.task_due | format_date if instance.task_due else '-' }}&lt;/td&gt;
&lt;/tr&gt;
{% endfor %}{% endraw %}</code></pre>
    </div>
</div>
{% endblock %}
