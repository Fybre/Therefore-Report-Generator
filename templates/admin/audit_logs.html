{% extends "base.html" %}

{% block title %}Audit Logs - Therefore Report Generator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Audit Logs</h1>
    <a href="/admin/users" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to User Admin
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-2"></i>Filters
    </div>
    <div class="card-body">
        <form method="get" action="/admin/audit-logs" class="row g-3">
            <div class="col-md-3">
                <label for="target_type" class="form-label">Target Type</label>
                <select class="form-select" id="target_type" name="target_type">
                    <option value="">All Types</option>
                    <option value="user" {{ 'selected' if filter_target_type == 'user' else '' }}>User</option>
                    <option value="tenant" {{ 'selected' if filter_target_type == 'tenant' else '' }}>Tenant</option>
                    <option value="report" {{ 'selected' if filter_target_type == 'report' else '' }}>Report</option>
                    <option value="template" {{ 'selected' if filter_target_type == 'template' else '' }}>Template</option>
                    <option value="smtp" {{ 'selected' if filter_target_type == 'smtp' else '' }}>SMTP Config</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="action" class="form-label">Action</label>
                <select class="form-select" id="action" name="action">
                    <option value="">All Actions</option>
                    <option value="create" {{ 'selected' if filter_action == 'create' else '' }}>Create</option>
                    <option value="update" {{ 'selected' if filter_action == 'update' else '' }}>Update</option>
                    <option value="delete" {{ 'selected' if filter_action == 'delete' else '' }}>Delete</option>
                    <option value="reset_password" {{ 'selected' if filter_action == 'reset_password' else '' }}>Reset Password</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="user_id" class="form-label">User</label>
                <select class="form-select" id="user_id" name="user_id">
                    <option value="">All Users</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {{ 'selected' if filter_user_id == u.id else '' }}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel me-2"></i>Filter
                </button>
                <a href="/admin/audit-logs" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-journal-text me-2"></i>Audit Log Entries</span>
        <span class="badge bg-secondary">{{ logs|length }} entries</span>
    </div>
    <div class="card-body p-0">
        {% if logs %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 160px;">Timestamp</th>
                        <th style="width: 100px;">Action</th>
                        <th style="width: 120px;">Target Type</th>
                        <th style="width: 80px;">Target ID</th>
                        <th>Details</th>
                        <th style="width: 120px;">User</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td class="text-nowrap font-monospace small">
                            {{ log.timestamp[:19] | replace('T', ' ') if log.timestamp else '-' }}
                        </td>
                        <td>
                            {% if log.action == 'create' %}
                            <span class="badge bg-success"><i class="bi bi-plus-lg me-1"></i>Create</span>
                            {% elif log.action == 'update' %}
                            <span class="badge bg-primary"><i class="bi bi-pencil me-1"></i>Update</span>
                            {% elif log.action == 'delete' %}
                            <span class="badge bg-danger"><i class="bi bi-trash me-1"></i>Delete</span>
                            {% elif log.action == 'reset_password' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-key me-1"></i>Reset PW</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ log.action }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.target_type == 'user' %}
                            <i class="bi bi-person me-1"></i>User
                            {% elif log.target_type == 'tenant' %}
                            <i class="bi bi-buildings me-1"></i>Tenant
                            {% elif log.target_type == 'report' %}
                            <i class="bi bi-file-text me-1"></i>Report
                            {% elif log.target_type == 'template' %}
                            <i class="bi bi-envelope me-1"></i>Template
                            {% elif log.target_type == 'smtp' %}
                            <i class="bi bi-gear me-1"></i>SMTP
                            {% else %}
                            {{ log.target_type }}
                            {% endif %}
                        </td>
                        <td class="font-monospace small">{{ log.target_id or '-' }}</td>
                        <td class="small">{{ log.details }}</td>
                        <td class="small">
                            {% if log.username %}
                            <span class="text-muted">{{ log.username }}</span>
                            {% else %}
                            <span class="text-muted">System</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No audit logs found</h5>
            <p>Try adjusting your filters or check back later.</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>About Audit Logs:</strong> This page shows a history of all administrative actions performed in the system, including user management, tenant configuration, report creation, template updates, and SMTP settings changes. Logs are retained indefinitely.
</div>
{% endblock %}
